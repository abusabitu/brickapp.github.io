<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Brick — Reset Password</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:#111;background:#fff}
  .site-header{padding:18px 28px;border-bottom:1px solid #eee;background:#fff}
  .logo img{height:40px}
  .hero{padding:60px 20px;text-align:center}
  .hero h1{font-size:2rem;margin-bottom:12px}
  .hero p{color:#555;margin-bottom:24px}
  .form-box{
    max-width:420px;
    margin:0 auto;
    background:#fff;
    border:1px solid #f0f0f0;
    box-shadow:0 10px 30px rgba(0,0,0,.05);
    padding:32px;
    border-radius:12px;
    text-align:left
  }
  label{display:block;margin-bottom:8px;font-weight:600;color:#111}
  .input-group{position:relative;margin-bottom:22px}
  input{
    width:100%;
    padding:16px 50px 16px 14px;
    border-radius:10px;
    border:1px solid #ddd;
    font-size:1rem;
    background:#f7f7f7;
    box-sizing:border-box;
  }
  .toggle{
    position:absolute;
    right:14px;
    top:50%;
    transform:translateY(-50%);
    cursor:pointer;
    width:24px;
    height:24px;
  }
  .toggle svg{
    width:100%;
    height:100%;
    stroke:#666;
    transition:stroke 0.2s ease;
  }
  .toggle:hover svg{stroke:#111;}
  button{
    width:100%;
    padding:14px;
    background:#111;
    color:#fff;
    font-weight:700;
    border:none;
    border-radius:10px;
    cursor:pointer;
    margin-top:16px;
    font-size:1rem;
  }
  button:disabled{background:#aaa;cursor:not-allowed}
  .msg{margin-top:16px;font-size:.95rem;text-align:center}
  ul.rules{list-style:none;padding:0;margin:16px 0 0;font-size:.9rem}
  ul.rules li{margin:6px 0;color:#999}
  ul.rules li.valid{color:green;font-weight:600}
  .match-note{font-size:.9rem;margin-top:-8px;margin-bottom:14px}
  .match-note.valid{color:green}
  .match-note.invalid{color:red}
</style>
</head>
<body>

<div class="site-header">
  <div class="logo"><img src="images/logo.png" alt="Brick logo"><strong style="font-size:1.05rem;margin-left:8px">Brick</strong></div>
</div>

<section class="hero">
  <h1>Reset Your Password</h1>
  <p>Please create a new password for your Brick account.</p>
  <div class="form-box">
    
    <label for="password">New Password</label>
    <div class="input-group">
      <input type="password" id="password" placeholder="Enter new password">
      <span class="toggle" onclick="toggleView('password', this)">
        <!-- eye hidden by default -->
        <svg class="eye" style="display:none" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2">
          <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"/>
          <circle cx="12" cy="12" r="3"/>
        </svg>
        <!-- eye-slash visible by default -->
        <svg class="eye-slash" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2">
          <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"/>
          <circle cx="12" cy="12" r="3"/>
          <line x1="4" y1="4" x2="20" y2="20" stroke="#666" stroke-width="2"/>
        </svg>
      </span>
    </div>

    <label for="confirm">Confirm Password</label>
    <div class="input-group">
      <input type="password" id="confirm" placeholder="Confirm new password">
      <span class="toggle" onclick="toggleView('confirm', this)">
        <svg class="eye" style="display:none" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2">
          <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"/>
          <circle cx="12" cy="12" r="3"/>
        </svg>
        <svg class="eye-slash" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2">
          <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"/>
          <circle cx="12" cy="12" r="3"/>
          <line x1="4" y1="4" x2="20" y2="20" stroke="#666" stroke-width="2"/>
        </svg>
      </span>
    </div>

    <div id="matchNote" class="match-note"></div>

    <ul class="rules" id="rules">
      <li id="rule-length">At least 8 characters</li>
      <li id="rule-upper">At least 1 uppercase letter</li>
      <li id="rule-lower">At least 1 lowercase letter</li>
      <li id="rule-digit">At least 1 number</li>
    </ul>

    <button id="resetBtn" disabled>Reset Password</button>
    <div id="msg" class="msg"></div>
  </div>
</section>

<script>
const btn = document.getElementById("resetBtn");
const msg = document.getElementById("msg");
const password = document.getElementById("password");
const confirmPass = document.getElementById("confirm");
const matchNote = document.getElementById("matchNote");

const rules = {
  length: document.getElementById("rule-length"),
  upper: document.getElementById("rule-upper"),
  lower: document.getElementById("rule-lower"),
  digit: document.getElementById("rule-digit"),
};

function toggleView(id, el){
  const input = document.getElementById(id);
  const eye = el.querySelector(".eye");
  const slash = el.querySelector(".eye-slash");

  if(input.type === "password"){
    input.type = "text";
    eye.style.display = "block";
    slash.style.display = "none";
  } else {
    input.type = "password";
    eye.style.display = "none";
    slash.style.display = "block";
  }
}

// password validation
password.addEventListener("input", validateForm);
confirmPass.addEventListener("input", validateForm);

function validateForm(){
  const val = password.value;
  const confirmVal = confirmPass.value;

  checkRule(rules.length, val.length >= 8);
  checkRule(rules.upper, /[A-Z]/.test(val));
  checkRule(rules.lower, /[a-z]/.test(val));
  checkRule(rules.digit, /[0-9]/.test(val));

  const valid = val.length >= 8 && /[A-Z]/.test(val) && /[a-z]/.test(val) && /[0-9]/.test(val);

  if(confirmVal.length > 0){
    if(val === confirmVal){
      matchNote.textContent = "✅ Passwords match";
      matchNote.className = "match-note valid";
    } else {
      matchNote.textContent = "❌ Passwords do not match";
      matchNote.className = "match-note invalid";
    }
  } else {
    matchNote.textContent = "";
    matchNote.className = "match-note";
  }

  btn.disabled = !(valid && val === confirmVal);
}

function checkRule(el, ok){
  if(ok){ el.classList.add("valid"); }
  else{ el.classList.remove("valid"); }
}

// Extract ONLY the token from the URL
const url = new URL(window.location.href);
let token = url.searchParams.get("token") || "";
token = token.trim();

btn.addEventListener("click", async () => {
  const pass = password.value.trim();
  const confirm = confirmPass.value.trim();
  if(pass !== confirm) return;

  btn.disabled = true;
  msg.textContent = "Resetting password...";

  try {
    const res = await fetch("https://x8ki-letl-twmt.n7.xano.io/api:WEYibcEJ/auth/reset_password", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ token: token, new_password: pass })
    });

    const data = await res.json();
    if(res.ok){
      msg.textContent = "✅ Password reset successful. You can log in now.";
      msg.style.color = "green";
    } else {
      msg.textContent = data.message || "❌ Reset failed.";
      msg.style.color = "red";
    }
  } catch(err){
    msg.textContent = "❌ Network error. Try again.";
    msg.style.color = "red";
  }
  btn.disabled = false;
});
</script>

</body>
</html>
